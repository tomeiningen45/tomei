#!/bin/sh
# \
if [ -e /usr/bin/tclsh ]; then exec /usr/bin/tclsh "$0" ${1+"$@"} ; fi
# \
if [ -e /usr/local/bin/tclsh8.4 ]; then exec /usr/local/bin/tclsh8.4 "$0" ${1+"$@"} ; fi
# \
if [ -e /usr/local/bin/tclsh8.3 ]; then exec /usr/local/bin/tclsh8.3 "$0" ${1+"$@"} ; fi
# \
if [ -e /usr/bin/tclsh8.4 ]; then exec /usr/bin/tclsh8.4 "$0" ${1+"$@"} ; fi
# \
exec tclsh "$0" ${1+"$@"}


#----------------------------------------------------------------------
# This is for testing in the command-line
#
if {![info exists env(QUERY_STRING)]} {
    set env(QUERY_STRING) [lindex $argv 0]
}
if {![info exists env(SCRIPT_NAME)]} {
    set env(SCRIPT_NAME) [info script]
}
if {![info exists env(HTTP_HOST)]} {
    set env(HTTP_HOST) localhost:8015
}
if {![info exists env(DOCUMENT_ROOT)]} {
    set env(DOCUMENT_ROOT) [exec sh -c "cd [file dirname [info script]]; cd ..; pwd"]
    set isfake 1
}
#----------------------------------------------------------------------test


proc main {} {
    global env

    if {"$env(QUERY_STRING)" != ""} {
        if {[regexp {^name=(.*)} $env(QUERY_STRING) dummy name]} {
            if {[get_movie $name]} {
                exit 0
            }
        }
    }

    hint
}

proc get_movie {name} {
    global env isfake


    set file $env(DOCUMENT_ROOT)/sample_mpeg4.mp4

    if {[file exists $file]} {
        puts "Content-Type: video/mp4"
        puts ""

        set fd [open $file r]
        fconfigure $fd -encoding binary -translation binary

        if {![info exists isfake]} {
            fconfigure stdout -encoding binary -translation binary
        }
        
        while {![eof $fd]} {
            set data [read $fd 4096]
            if {![info exists isfake]} {
                puts -nonewline stdout $data
            }
        }
        close $fd
        flush stdout
    } else {
        return 0;
    }

    return 1
}

proc hint {} {
    global env fetch_err

    puts "Content-Type: text/html"
    puts ""
    puts <ul>

    foreach {name title} {
        CARandDRIVER "Car and Driver"
    } {
        puts "<li><a href=$env(SCRIPT_NAME)?name=$name>$title</li>"
    }
    puts "</ul>"
    if {[info exists fetch_err]} {
        puts "<pre>ERROR:\n$fetch_err</pre>"
    }
}


main
exit 0
